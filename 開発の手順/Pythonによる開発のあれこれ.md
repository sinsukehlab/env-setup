# Python による開発のあれこれ

## 必要なもの

- [【Windows 簡略版】環境構築の手順](../環境構築の手順/【Windows簡略版】環境構築の手順.md)か[【Mac 簡略版】環境構築の手順](../環境構築の手順/【Mac簡略版】環境構築の手順.md)のいずれかの手順をすべて行っていること。

## このマニュアルを理解するのに必要な前提知識

- [開発の手順](./開発の手順.md)に書かれた内容が理解できること。

## 1. リンターについて

リンターとは、あるコーディングルールに沿っているかどうかをチェック、可能な場合はコードに修正を加えるアプリである。  
まずは例を挙げよう。

```python
if a == True:
    print("a is True")
```

この例をファイルとして保存すると、`if a == True:`を`if a is True:`か`if a:`にすべきだとリンター(Flake8)が提案してくるはずだ。

これは、`a`に数字の`1`が入っていた場合でも条件式が真となることが問題であるという指摘である。もし、`a`が本当に`True`の場合のみ条件式が真になるようにしたいならば`if a is True:`とすべきであるし、逆に`a`が`True`だろうと`1`だろうと(Truthy なものは)条件式が真になるようにしたいならば`if a:`とすべきで、直感的に`False`と誤解しうる`if 1 == True:`は避けるべきである、ということである。

※「誤解しうる」のはそのプログラムをチェックしたり使ったりする他人でもあり、すっかり自分の書いたコードを忘れてしまった数か月後の自分自身でもある。このような小さな問題一つ一つの積み重ねがバグや開発効率の悪さを生むので、コードを書くときは可読性に気を使ったり、出来るだけ「ベストプラクティス」に従うべきである。

このようにリンターは、場合によってはプログラムの動作に変化が起こりうるような文法単位での改善を提案し、自動で「ベストプラクティス」を提案してくれるプログラマにとっては嬉しいアプリである。ちなみにコードフォーマッタはスペースや改行の数などの見た目、つまりプログラムの動作には影響がない部分を修正するアプリである。

### リンターの無効化について

リンターは、時にプログラマの意図しない提案をする場合がある。

```python
from numpy import *
```

このコードは`numpy`の全てのクラスや関数をインポートするというコードだが、リンターは「個別のインポートに変えるべきだ」という提案をする。これは`numpy`の全てのクラスや関数をインポートすることは、プログラマが予期せず`numpy`の必要のないクラスや関数を使ってしまい得るからである。グローバル空間の汚染と呼ばれる問題で、非常にお勧めできない構文ではあるが、いちいち import しなくてよいというメリットは大きい。

もし、`from ~ import *`という構文をどうしても使いたい場合は、次のようにしてこのルールだけリンターに無視させることもできる。

```python
from numpy import * # noqa: F403
```

`F403`というのは、リンターが指摘する問題のコードで、リンターのエラー文の中にカッコつきで書かれているものである。この`noqa:`というコメントが書かれた行は、そのコードが示すリントルールに限りリンターによるチェックが無効化される。

なお、`settings.json`に設定を記載することでリポジトリ全体で無効化することもできる。詳しくはネットで調べてみてほしい。

ちなみに、このインポート文に関しては、基本的にはリントルールの無視ではなく以下のように修正することをお勧めする。

```python
from numpy import * as np
```

初心者にとって、リンターの指摘する問題や修正の方法が分からない場合、リンターの指摘はとても鬱陶しいものに感じると思う。これらの指摘はまわりまわって自分にメリットとなって返ってくるため、きちんと修正することをお勧めするが、どうしても邪魔な場合は拡張機能の Flake8 自体をアンインストールする。

## 2. 仮想環境について

仮想環境を使った開発とは、プロジェクト(リポジトリ)ごとに「環境」を作り、それぞれで Python やライブラリをインストールするという手法である。こうすることで、プロジェクト A で、あるライブラリをバージョン 1 で使っているけど、プロジェクト B ではバージョン 2 で使っている、ということができるようになる。

仮想環境を使わない場合、全てのプロジェクトで Python やライブラリのバージョンを統一することが必要になる。全てのプロジェクトで最新版の Python やライブラリを使えばいいじゃんと思うかもしれないが、ライブラリは更新のたびに非推奨や廃止となる関数や機能があるため、プロジェクト A で発生した問題を解決するためライブラリのバージョンを上げたらプロジェクト B が動かなくなった、みたいなことはよくあることである。特に、古いプロジェクトにはアーカイブのようになっていてもう触ることがない、というものもあるだろうから、新しいプロジェクトを作るたびに古いプロジェクトが動かなくなっていく、というのも問題である。

また、他にも環境の作り直しがきくとか、環境にインストールされているライブラリが少ないから軽いとか問題が特定しやすいとかいったメリットがある。

そういったわけで、新しいライブラリをインストールする必要がある場合は、仮想環境を作ることをお勧めする。  
Python では、以下のようにして仮想環境が構築できる。

```shell
python -m venv .venv
source .venv/bin/activate
```

`.venv`の部分は実際には任意に設定できるが、基本的には`.venv`でよい。  
このコマンドを実行すると、1 行目で実行した場所に`.venv`フォルダが作られ、そこに Python がインストールされる。2 行目は仮想環境のアクティベートを行い、それ以降で実行された`python`コマンドは`.venv`フォルダのものが利用されるようになる。  
なお、プロンプト(ターミナル)にも以下の`(Python仮想環境名)`の場所に今アクティベートされている仮想環境名が表示される。

```console
[時刻] ユーザー名 (Python仮想環境名) ワーキングディレクトリ [Git情報]
$
```

なお、ディアクティベートは次のコマンドを実行する。

```shell
deactivate
```

仮想環境へのライブラリのインストールは次のようにすることをお勧めする。  
まず、`requirements.txt` という名前のファイルを作り、そこに以下のようにインストールするライブラリとバージョンを書く。

```txt
numpy==1.25.2
scipy==1.11.2
```

なお、バージョンの指定方法は`パッケージ名==バージョン`でなくても、`パッケージ名>=バージョン`や`パッケージ名>=最低バージョン,<最高バージョン`などとしてもよい。  
次に、仮想環境がアクティベートされている状態で次のコマンドを実行することで、`.venv`フォルダにライブラリをインストールすることができる。

```shell
pip install -r requirements.txt
```

こうすると、インストールしたパッケージは全て`requirements.txt`に記録できるため、後で環境を作り直したり(`.venv`フォルダを削除して作り直す)、別のパソコンでの環境構築することが簡単になる。つまり、別のパソコンで環境を再現したい際は、`requirements.txt`を用意して以下のコマンドを実行すればよい。

```shell
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

### 少し高度な話(知りたい人だけ)

少し高度な話だが、`requirements.txt`に書かれているライブラリはインストールされている全てのファイルが書かれているわけではない。  
自動でインストールされているライブラリもあるため、それらまで含めて完全な環境の再現を行いたい場合は、以下のコマンドで全てのライブラリをリスト化することができる。

```shell
pip freeze > requirements.lock
```

インストールは`requirements.txt`と同じように出来る。

```shell
pip install -r requirements.lock
```

`requirements.lock`は環境の完全再現を行うことができるが、膨大なライブラリが記録されているため、直接自分でインストールしたライブラリが分からなくなり、アップグレードやダウングレードが困難になる。  
そのため、環境構築には`requirements.lock`を使い、ライブラリのアップデート等には`requirements.txt`を使い、同時に`pip freeze`で`requirements.lock`もアップデートする、というのが個人的には理想的ではあると思う。

### Anaconda について

上で紹介したのは venv という仮想環境を作るアプリを使った仮想環境の作成方法である。venv は Python 標準が提供する仮想環境であり、基本これを使うことが推奨されるが、比較的新しく、古くから使われていた Anaconda という非標準のアプリを使っているプロジェクトも多い。

もし、古いプロジェクトを動かしたいという場合で、Anaconda をインストールする場合は[Anaconda のインストール方法](../環境構築の手順/Anacondaのインストール方法.md)を参考にしてインストールする。

仮想環境の作成などのコマンドは以下の通り。

```shell
# 仮想環境の作成
conda create -n 環境名

# ファイルからの仮想環境の作成
conda env create -f YAMLファイル名

# 仮想環境のアクティベート
source activate 環境名

# 仮想環境のディアクティベート
source deactivate

# ライブラリのインストール
conda install ライブラリ名

# 仮想環境の削除
conda remove -n 環境名 --all

# 存在する全ての仮想環境の表示
conda info -e
```

なお、Anaconda では`.venv`のようなフォルダは作られず、Anaconda がインストールされている場所に仮想環境ごとの Python やライブラリが保存されるようになっている。
